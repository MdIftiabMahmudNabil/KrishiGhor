<!DOCTYPE html>
<html lang="en" class="bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiGhor - Bangladesh Crop Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        header {
            background-color: #2e7d32;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #crops-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        .crop-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
        }

        #cart-sidebar {
            position: fixed;
            right: 0;
            top: 0;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        #cart-sidebar.show {
            transform: translateX(0);
        }

        /* Dark mode styles */
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .dark .bg-white {
            background-color: #2d3748;
            color: #e2e8f0;
        }

        .dark .bg-gray-50 {
            background-color: #4a5568;
        }

        .dark .text-gray-800 {
            color: #e2e8f0;
        }

        .dark .border-gray-200 {
            border-color: #4a5568;
        }

        /* Dashboard styles */
        #buyer-dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        #orders-table-body tr:hover {
            background-color: rgba(74, 85, 104, 0.1);
        }

        .dark #orders-table-body tr:hover {
            background-color: rgba(74, 85, 104, 0.5);
        }

        /* Checkout modal styles */
        #bkash-details {
            transition: all 0.3s ease;
        }

        /* Animation for loading */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <header class="bg-green-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-leaf text-2xl text-yellow-300"></i>
                <h1 class="text-2xl font-bold">KrishiGhor</h1>
                <span class="bg-yellow-500 text-green-800 px-2 py-1 rounded-full text-xs">বাংলাদেশ</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full bg-green-800 hover:bg-green-900">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="dashboard-btn" class="p-2 rounded-full bg-green-800 hover:bg-green-900 text-white">
                    <i class="fas fa-tachometer-alt"></i>
                </button>
                <div id="cart-btn" class="relative cursor-pointer">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-yellow-400 text-green-900 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hidden">0</span>
                </div>
            </div>
        </div>
    </header>

    <section class="bg-gradient-to-r from-green-600 to-green-800 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl font-bold mb-4">Bangladesh's Digital Crop Marketplace</h2>
            <p class="max-w-2xl mx-auto">Connecting farmers directly with buyers across Dhaka, Chittagong, Khulna, and all regions</p>
            <div class="mt-6 relative max-w-md mx-auto">
                <input type="text" id="main-search" placeholder="Search crops (rice, jute, vegetables...)" 
                       class="w-full px-4 py-3 rounded-full text-gray-800 focus:outline-none">
                <button class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-yellow-400 text-green-800 px-4 py-1 rounded-full">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </section>

    <section class="container mx-auto px-4 py-8" id="ai-section">
        <h3 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-robot text-green-600 mr-2"></i> AI Crop Suggestions
        </h3>
        <div id="ai-recommendations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-robot text-blue-400 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">AI Recommendations</h3>
                        <p class="text-sm text-blue-700 mt-1">
                            Add items to your cart to get personalized crop suggestions.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <main class="container mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">Available Crops</h2>
            <div class="flex space-x-2">
                <select id="region-filter" class="px-3 py-2 border rounded-lg bg-white">
                    <option value="">All Regions</option>
                    <option>Dhaka</option>
                    <option>Chittagong</option>
                    <option>Khulna</option>
                    <option>Rajshahi</option>
                    <option>Sylhet</option>
                    <option>Barisal</option>
                    <option>Rangpur</option>
                    <option>Mymensingh</option>
                </select>
                <select id="type-filter" class="px-3 py-2 border rounded-lg bg-white">
                    <option value="">All Types</option>
                    <option>Rice</option>
                    <option>Pulse</option>
                    <option>Vegetable</option>
                    <option>Fruit</option>
                    <option>Nut</option>
                    <option>Fiber</option>
                    <option>Oilseed</option>
                </select>
            </div>
        </div>

        <div id="crops-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Filled by JavaScript -->
        </div>
    </main>

    <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full md:w-96 bg-white shadow-lg transform translate-x-full transition-transform z-50">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-bold text-lg">Your Order</h3>
            <button id="close-cart" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="cart-items" class="p-4 overflow-y-auto h-3/4">
            <div class="text-center py-12">
                <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">Your cart is empty</p>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t bg-gray-50">
            <div class="flex justify-between font-bold mb-4">
                <span>Total:</span>
                <span id="cart-total">৳0</span>
            </div>
            <button id="checkout-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
                Proceed to Checkout
            </button>
        </div>
    </div>

    <script>
        const cropsContainer = document.getElementById('crops-container');
        const cartBtn = document.getElementById('cart-btn');
        const cartSidebar = document.getElementById('cart-sidebar');
        const closeCart = document.getElementById('close-cart');
        const cartItemsEl = document.getElementById('cart-items');
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total');
        const regionFilter = document.getElementById('region-filter');
        const typeFilter = document.getElementById('type-filter');
        const mainSearch = document.getElementById('main-search');
        const aiSection = document.getElementById('ai-section');
        const checkoutBtn = document.getElementById('checkout-btn');
        const dashboardBtn = document.getElementById('dashboard-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let allCrops = [];

        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5000' 
            : '/api';

        // Demo user
        let currentUser = {
            id: 2, // Matches the demo_buyer in database
            username: 'demo_buyer',
            email: 'buyer@example.com',
            user_type: 'buyer'
        };

        // Theme toggle
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.classList.toggle('dark', savedTheme === 'dark');
        themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        
        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchCrops();
            renderCrops();
            updateCartUI();
            setupEventListeners();
            getAiRecommendations();
        });

        async function fetchCrops() {
            try {
                showLoading(true);
                const response = await fetch(`${API_BASE}/crops`);
                const data = await response.json();
                allCrops = data;
                showLoading(false);
            } catch (error) {
                console.error('Error fetching crops:', error);
                showError('Failed to load crops. Please refresh the page.');
                showLoading(false);
            }
        }

        function renderCrops(filteredCrops = allCrops) {
            if (filteredCrops.length === 0) {
                cropsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-seedling text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No crops found matching your filters</p>
                        <button id="reset-filters" class="mt-4 text-green-600 hover:text-green-800">
                            <i class="fas fa-redo mr-2"></i> Reset filters
                        </button>
                    </div>
                `;
                return;
            }

            cropsContainer.innerHTML = filteredCrops.map(crop => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
                    <div class="h-48 bg-green-50 flex items-center justify-center relative dark:bg-gray-700">
                        <i class="fas fa-seedling text-4xl text-green-600 dark:text-green-400"></i>
                        ${crop.quantity < 100 ? `
                            <span class="absolute top-2 right-2 bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full dark:bg-red-900 dark:text-red-200">
                                Low Stock
                            </span>
                        ` : ''}
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg dark:text-white">${crop.name}</h3>
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded dark:bg-green-900 dark:text-green-200">${crop.type}</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-1 dark:text-gray-300">
                            <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>
                            ${crop.region}
                        </p>
                        <p class="text-sm text-gray-500 mt-2 line-clamp-2 dark:text-gray-400">${crop.description || 'No description available'}</p>
                        
                        <div class="mt-4 flex justify-between items-center">
                            <div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">Available:</span>
                                <span class="block font-medium dark:text-white">${crop.quantity} kg</span>
                            </div>
                            <button class="add-to-cart bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center"
                                    data-id="${crop.id}">
                                <i class="fas fa-cart-plus mr-2"></i> Add
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addToCart(cropId) {
            const crop = allCrops.find(c => c.id === cropId);
            if (!crop) return;

            const existingItem = cart.find(item => item.id === cropId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ 
                    id: crop.id,
                    name: crop.name,
                    type: crop.type,
                    quantity: 1,
                    price: crop.price || 0,
                    region: crop.region
                });
            }
            
            updateCartUI();
            showToast(`${crop.name} added to cart`);
        }

        function updateCartUI() {
            localStorage.setItem('cart', JSON.stringify(cart));
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            cartCount.classList.toggle('hidden', totalItems === 0);
            
            if (cart.length === 0) {
                cartItemsEl.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Your cart is empty</p>
                    </div>
                `;
                cartTotal.textContent = '৳0';
                return;
            }
            
            cartItemsEl.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center py-3 border-b dark:border-gray-600">
                    <div class="flex-1">
                        <h4 class="font-medium dark:text-white">${item.name}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-300">${item.type} • ${item.region}</p>
                    </div>
                    <div class="flex items-center ml-4">
                        <button class="decrease-quantity text-gray-500 hover:text-green-600 px-2 dark:text-gray-400" 
                                data-id="${item.id}">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="quantity-display mx-2 w-8 text-center dark:text-white">${item.quantity}</span>
                        <button class="increase-quantity text-gray-500 hover:text-green-600 px-2 dark:text-gray-400" 
                                data-id="${item.id}">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span class="ml-4 font-medium w-20 text-right dark:text-white">৳${(item.quantity * item.price).toFixed(2)}</span>
                        <button class="remove-from-cart text-red-500 hover:text-red-700 ml-4 dark:text-red-400" 
                                data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            const total = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            cartTotal.textContent = `৳${total.toFixed(2)}`;
        }

        async function getAiRecommendations() {
            if (cart.length === 0) {
                aiSection.innerHTML = `
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded dark:bg-blue-900 dark:border-blue-600">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-robot text-blue-400 text-xl dark:text-blue-300"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800 dark:text-blue-200">AI Recommendations</h3>
                                <p class="text-sm text-blue-700 mt-1 dark:text-blue-300">
                                    Add items to your cart to get personalized crop suggestions.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            try {
                aiSection.innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <i class="fas fa-spinner fa-spin text-green-500 mr-3"></i>
                        <span class="text-gray-600 dark:text-gray-300">AI is analyzing your cart...</span>
                    </div>
                `;

                const response = await fetch(`${API_BASE}/recommendations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cart: cart
                    })
                });

                const data = await response.json();

                if (data.success && data.recommendations.length > 0) {
                    renderAiRecommendations(data.recommendations);
                } else {
                    aiSection.innerHTML = `
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded dark:bg-yellow-900 dark:border-yellow-600">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-robot text-yellow-400 text-xl dark:text-yellow-300"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">AI Recommendations</h3>
                                    <p class="text-sm text-yellow-700 mt-1 dark:text-yellow-300">
                                        Try adding more items to get better suggestions.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('AI Recommendation Error:', error);
                aiSection.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded dark:bg-red-900 dark:border-red-600">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-400 text-xl dark:text-red-300"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800 dark:text-red-200">AI Service Unavailable</h3>
                                <p class="text-sm text-red-700 mt-1 dark:text-red-300">
                                    We couldn't load recommendations. Please try again later.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderAiRecommendations(recommendations) {
            aiSection.innerHTML = `
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-robot text-green-600 mr-2"></i> AI Crop Suggestions
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${recommendations.map(crop => `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
                            <div class="h-48 bg-green-50 flex items-center justify-center relative dark:bg-gray-700">
                                <i class="fas fa-seedling text-4xl text-green-600 dark:text-green-400"></i>
                                ${crop.quantity < 100 ? `
                                    <span class="absolute top-2 right-2 bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full dark:bg-red-900 dark:text-red-200">
                                        Low Stock
                                    </span>
                                ` : ''}
                            </div>
                            <div class="p-4">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-lg dark:text-white">${crop.name}</h3>
                                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded dark:bg-green-900 dark:text-green-200">${crop.type}</span>
                                </div>
                                <p class="text-gray-600 text-sm mt-1 dark:text-gray-300">
                                    <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>
                                    ${crop.region}
                                </p>
                                <p class="text-sm text-gray-500 mt-2 line-clamp-2 dark:text-gray-400">${crop.description || 'No description available'}</p>
                                
                                <div class="mt-4 flex justify-between items-center">
                                    <div>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">Available:</span>
                                        <span class="block font-medium dark:text-white">${crop.quantity} kg</span>
                                    </div>
                                    <button class="add-to-cart bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center"
                                            data-id="${crop.id}">
                                        <i class="fas fa-cart-plus mr-2"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function setupEventListeners() {
            cartBtn.addEventListener('click', toggleCart);
            closeCart.addEventListener('click', toggleCart);
            document.addEventListener('click', handleDocumentClick);
            regionFilter.addEventListener('change', filterCrops);
            typeFilter.addEventListener('change', filterCrops);
            mainSearch.addEventListener('input', filterCrops);
            checkoutBtn.addEventListener('click', handleCheckout);
            dashboardBtn.addEventListener('click', showBuyerDashboard);
        }

        function toggleCart() {
            cartSidebar.classList.toggle('translate-x-full');
            document.body.classList.toggle('overflow-hidden');
        }

        function handleDocumentClick(e) {
            if (e.target.classList.contains('add-to-cart') || e.target.closest('.add-to-cart')) {
                const btn = e.target.classList.contains('add-to-cart') ? e.target : e.target.closest('.add-to-cart');
                const cropId = parseInt(btn.dataset.id);
                addToCart(cropId);
            }
            
            if (e.target.classList.contains('remove-from-cart') || e.target.closest('.remove-from-cart')) {
                const btn = e.target.classList.contains('remove-from-cart') ? e.target : e.target.closest('.remove-from-cart');
                const cropId = parseInt(btn.dataset.id);
                cart = cart.filter(item => item.id !== cropId);
                updateCartUI();
                getAiRecommendations();
            }
            
            if (e.target.classList.contains('increase-quantity') || e.target.closest('.increase-quantity')) {
                const btn = e.target.classList.contains('increase-quantity') ? e.target : e.target.closest('.increase-quantity');
                const cropId = parseInt(btn.dataset.id);
                const item = cart.find(item => item.id === cropId);
                if (item) item.quantity += 1;
                updateCartUI();
                getAiRecommendations();
            }
            
            if (e.target.classList.contains('decrease-quantity') || e.target.closest('.decrease-quantity')) {
                const btn = e.target.classList.contains('decrease-quantity') ? e.target : e.target.closest('.decrease-quantity');
                const cropId = parseInt(btn.dataset.id);
                const item = cart.find(item => item.id === cropId);
                if (item) {
                    item.quantity -= 1;
                    if (item.quantity <= 0) {
                        cart = cart.filter(i => i.id !== cropId);
                    }
                }
                updateCartUI();
                getAiRecommendations();
            }
            
            if (e.target.id === 'reset-filters' || e.target.closest('#reset-filters')) {
                regionFilter.value = '';
                typeFilter.value = '';
                mainSearch.value = '';
                filterCrops();
            }
        }

        function filterCrops() {
            const region = regionFilter.value;
            const type = typeFilter.value;
            const searchTerm = mainSearch.value.toLowerCase();
            
            const filtered = allCrops.filter(crop => {
                return (!region || crop.region === region) &&
                       (!type || crop.type === type) &&
                       (!searchTerm || 
                        crop.name.toLowerCase().includes(searchTerm) || 
                        (crop.description && crop.description.toLowerCase().includes(searchTerm)));
            });
            
            renderCrops(filtered);
        }

        async function handleCheckout() {
            if (cart.length === 0) {
                showToast('Your cart is empty!', 'error');
                return;
            }

            // Show checkout modal
            const checkoutModal = document.createElement('div');
            checkoutModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            checkoutModal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto dark:bg-gray-800">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold dark:text-white">Checkout</h3>
                            <button id="close-checkout" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold mb-2 dark:text-white">Shipping Information</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Full Name</label>
                                        <input type="text" id="shipping-name" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="Demo User">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Email</label>
                                        <input type="email" id="shipping-email" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="${currentUser.email}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Phone Number</label>
                                        <input type="tel" id="shipping-phone" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="+8801XXXXXXXXX">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Region</label>
                                        <select id="shipping-region" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                            <option>Dhaka</option>
                                            <option>Chittagong</option>
                                            <option>Khulna</option>
                                            <option>Rajshahi</option>
                                            <option>Sylhet</option>
                                            <option>Barisal</option>
                                            <option>Rangpur</option>
                                            <option>Mymensingh</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Address</label>
                                        <textarea id="shipping-address" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="3">123 Farmgate, Dhaka</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-bold mb-2 dark:text-white">Order Summary</h4>
                                <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                                    <div id="checkout-items" class="space-y-2 mb-4">
                                        ${cart.map(item => `
                                            <div class="flex justify-between dark:text-white">
                                                <span>${item.name} x${item.quantity}</span>
                                                <span>৳${(item.price * item.quantity).toFixed(2)}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="border-t pt-2 dark:border-gray-600">
                                        <div class="flex justify-between font-bold dark:text-white">
                                            <span>Total:</span>
                                            <span id="checkout-total">৳${cart.reduce((sum, item) => sum + (item.quantity * item.price), 0).toFixed(2)}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-6">
                                        <h4 class="font-bold mb-2 dark:text-white">Payment Method</h4>
                                        <div class="space-y-2">
                                            <label class="flex items-center space-x-2 dark:text-white">
                                                <input type="radio" name="payment-method" value="cash_on_delivery" checked class="rounded-full dark:bg-gray-600">
                                                <span>Cash on Delivery</span>
                                            </label>
                                            <label class="flex items-center space-x-2 dark:text-white">
                                                <input type="radio" name="payment-method" value="bkash" class="rounded-full dark:bg-gray-600">
                                                <span>bKash</span>
                                            </label>
                                            <div id="bkash-details" class="hidden pl-6 mt-2 space-y-2">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">bKash Number</label>
                                                    <input type="tel" id="bkash-number" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="01XXXXXXXXX">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Transaction ID</label>
                                                    <input type="text" id="bkash-trx" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="TRX123456789">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button id="place-order-btn" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
                                        Place Order
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(checkoutModal);
            
            // Setup event listeners for the modal
            document.getElementById('close-checkout').addEventListener('click', () => {
                checkoutModal.remove();
            });
            
            // Show/hide bKash details based on payment method selection
            document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const bkashDetails = document.getElementById('bkash-details');
                    bkashDetails.classList.toggle('hidden', e.target.value !== 'bkash');
                });
            });
            
            // Handle place order button
            document.getElementById('place-order-btn').addEventListener('click', async () => {
                const shippingInfo = {
                    name: document.getElementById('shipping-name').value,
                    email: document.getElementById('shipping-email').value,
                    phone: document.getElementById('shipping-phone').value,
                    region: document.getElementById('shipping-region').value,
                    address: document.getElementById('shipping-address').value
                };
                
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                let paymentDetails = {};
                
                if (paymentMethod === 'bkash') {
                    paymentDetails = {
                        bkash_number: document.getElementById('bkash-number').value,
                        transaction_id: document.getElementById('bkash-trx').value
                    };
                    
                    if (!paymentDetails.bkash_number || !paymentDetails.transaction_id) {
                        showToast('Please provide bKash payment details', 'error');
                        return;
                    }
                }
                
                try {
                    const response = await fetch(`${API_BASE}/orders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: currentUser.id,
                            items: cart,
                            shipping_info: shippingInfo,
                            payment_method: paymentMethod
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showToast('Order placed successfully!', 'success');
                        cart = [];
                        updateCartUI();
                        getAiRecommendations();
                        checkoutModal.remove();
                        toggleCart();
                        
                        // Show order confirmation
                        showOrderConfirmation(data.order_id);
                    } else {
                        showToast(data.error || 'Failed to place order', 'error');
                    }
                } catch (error) {
                    console.error('Order error:', error);
                    showToast('Failed to place order', 'error');
                }
            });
        }

        function showOrderConfirmation(orderId) {
            const confirmationModal = document.createElement('div');
            confirmationModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmationModal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full dark:bg-gray-800">
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <i class="fas fa-check-circle text-5xl text-green-500 mb-3"></i>
                            <h3 class="text-xl font-bold dark:text-white">Order Confirmed!</h3>
                            <p class="text-gray-600 mt-1 dark:text-gray-300">Your order #${orderId} has been placed successfully.</p>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg mb-4 dark:bg-gray-700">
                            <p class="text-center mb-2 dark:text-white">You can track your order in your dashboard.</p>
                            <div class="flex justify-center space-x-3">
                                <button id="view-invoice" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800">
                                    <i class="fas fa-file-invoice mr-2"></i> View Invoice
                                </button>
                                <button id="go-to-dashboard" class="px-4 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200 dark:bg-green-900 dark:text-green-200 dark:hover:bg-green-800">
                                    <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                                </button>
                            </div>
                        </div>
                        
                        <button id="close-confirmation" class="w-full mt-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">
                            Continue Shopping
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmationModal);
            
            // Setup event listeners
            document.getElementById('close-confirmation').addEventListener('click', () => {
                confirmationModal.remove();
            });
            
            document.getElementById('go-to-dashboard').addEventListener('click', () => {
                confirmationModal.remove();
                showBuyerDashboard();
            });
            
            document.getElementById('view-invoice').addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE}/orders/invoice/${orderId}`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `invoice_${orderId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } else {
                        const error = await response.json();
                        showToast(error.error || 'Failed to download invoice', 'error');
                    }
                } catch (error) {
                    console.error('Invoice download error:', error);
                    showToast('Failed to download invoice', 'error');
                }
            });
        }

        function showBuyerDashboard() {
            // Hide main content
            document.querySelector('main').classList.add('hidden');
            document.getElementById('ai-section').classList.add('hidden');
            
            // Create dashboard container
            const dashboard = document.createElement('div');
            dashboard.className = 'container mx-auto px-4 py-8';
            dashboard.id = 'buyer-dashboard';
            dashboard.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold dark:text-white">My Dashboard</h2>
                    <button id="back-to-shop" class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Shop
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
                        <h3 class="font-bold text-lg mb-2 dark:text-white">Recent Orders</h3>
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400" id="order-count">0</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">orders placed</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
                        <h3 class="font-bold text-lg mb-2 dark:text-white">Pending Orders</h3>
                        <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400" id="pending-count">0</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">awaiting delivery</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
                        <h3 class="font-bold text-lg mb-2 dark:text-white">Total Spent</h3>
                        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="total-spent">৳0</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">all time</p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow mb-8 dark:bg-gray-800">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg dark:text-white">Order History</h3>
                        <button id="refresh-orders" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Items</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading orders...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Insert dashboard before footer
            document.querySelector('main').insertAdjacentElement('beforebegin', dashboard);
            
            // Load orders
            loadUserOrders();
            
            // Setup event listeners
            document.getElementById('back-to-shop').addEventListener('click', () => {
                dashboard.remove();
                document.querySelector('main').classList.remove('hidden');
                document.getElementById('ai-section').classList.remove('hidden');
            });
            
            document.getElementById('refresh-orders').addEventListener('click', loadUserOrders);
        }

        async function loadUserOrders() {
            try {
                const response = await fetch(`${API_BASE}/orders/${currentUser.id}`);
                const data = await response.json();
                
                if (data.success) {
                    const orders = data.orders;
                    
                    // Update summary cards
                    document.getElementById('order-count').textContent = orders.length;
                    document.getElementById('pending-count').textContent = 
                        orders.filter(o => o.status === 'pending' || o.status === 'processing').length;
                    document.getElementById('total-spent').textContent = 
                        '৳' + orders.reduce((sum, order) => sum + order.total_amount, 0).toFixed(2);
                    
                    // Update orders table
                    const ordersTable = document.getElementById('orders-table-body');
                    if (orders.length === 0) {
                        ordersTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No orders found</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    ordersTable.innerHTML = orders.map(order => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                                #${order.id.slice(0, 8)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                ${new Date(order.order_date).toLocaleDateString()}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                                ${order.items.length} item${order.items.length !== 1 ? 's' : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium dark:text-white">
                                ৳${order.total_amount.toFixed(2)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full 
                                    ${order.status === 'delivered' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                                      order.status === 'cancelled' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
                                      'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'}">
                                    ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="view-order text-green-600 hover:text-green-900 mr-3 dark:text-green-400 dark:hover:text-green-300" data-id="${order.id}">
                                    <i class="fas fa-eye mr-1"></i> View
                                </button>
                                <button class="download-invoice text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300" data-id="${order.id}">
                                    <i class="fas fa-download mr-1"></i> Invoice
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Add event listeners to view order buttons
                    document.querySelectorAll('.view-order').forEach(btn => {
                        btn.addEventListener('click', () => viewOrderDetails(btn.dataset.id));
                    });
                    
                    // Add event listeners to download invoice buttons
                    document.querySelectorAll('.download-invoice').forEach(btn => {
                        btn.addEventListener('click', () => downloadInvoice(btn.dataset.id));
                    });
                    
                } else {
                    showToast(data.error || 'Failed to load orders', 'error');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('Failed to load orders', 'error');
            }
        }

        function viewOrderDetails(orderId) {
            // In a real app, you would fetch the full order details
            // For this demo, we'll just show a simple modal
            showToast(`Viewing order #${orderId}`, 'info');
        }

        async function downloadInvoice(orderId) {
            try {
                const response = await fetch(`${API_BASE}/orders/invoice/${orderId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `invoice_${orderId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to download invoice', 'error');
                }
            } catch (error) {
                console.error('Invoice download error:', error);
                showToast('Failed to download invoice', 'error');
            }
        }

        function showLoading(show) {
            const loader = document.getElementById('loading-indicator');
            if (show) {
                if (!loader) {
                    const loaderDiv = document.createElement('div');
                    loaderDiv.id = 'loading-indicator';
                    loaderDiv.className = 'fixed top-0 left-0 w-full h-1 bg-green-500 z-50';
                    document.body.appendChild(loaderDiv);
                }
            } else {
                if (loader) {
                    loader.remove();
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } z-50 transform translate-y-10 opacity-0 transition-all duration-300`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 dark:bg-red-900 dark:border-red-700 dark:text-red-200';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            cropsContainer.parentNode.insertBefore(errorDiv, cropsContainer);
        }
    </script>
</body>
</html>